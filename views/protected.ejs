<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HEKO Pora | Panel de Administraci√≥n</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=Sora:wght@400;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Custom Registro M√©dico CSS -->
    <link rel="stylesheet" href="/css/registro-medico.css">

    <!-- Custom Especialidades CSS -->
    <link rel="stylesheet" href="/css/especialidades.css">

    <style>
        :root {
            --ink: #0f0b05;
            --paper: #fff9e6;
            --primary: #ffd02e;
            --primary-strong: #ffc700;
            --surface: #f4e8c5;
            --panel: #2b241a;
            --muted: rgba(15, 11, 5, 0.72);
            --border: rgba(15, 11, 5, 0.14);
            --success: #1c8c4a;
            --danger: #a02b2b;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Manrope', sans-serif;
            background: linear-gradient(155deg, #fff9e6 0%, #fff3c4 42%, #ffe38d 100%);
            color: var(--ink);
            min-height: 100vh;
        }

        /* Navbar customization */
        .navbar {
            background: linear-gradient(135deg, rgba(255, 208, 46, 0.95), rgba(255, 199, 0, 0.92)) !important;
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            box-shadow: 0 4px 20px rgba(255, 208, 46, 0.25);
        }

        .navbar-brand {
            font-family: 'Sora', sans-serif;
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--panel) !important;
            letter-spacing: -0.02em;
        }

        .navbar-brand .brand-accent {
            color: var(--ink);
            font-weight: 400;
        }

        .nav-link {
            color: var(--panel) !important;
            font-weight: 500;
            transition: all 0.2s ease;
            border-radius: 8px;
            padding: 0.5rem 1rem !important;
            margin: 0 0.25rem;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .nav-link.active {
            background: rgba(43, 36, 26, 0.15) !important;
            font-weight: 600;
        }

        .btn-logout {
            background: var(--panel);
            color: var(--primary);
            border: none;
            font-weight: 600;
            padding: 0.5rem 1.25rem;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .btn-logout:hover {
            background: var(--ink);
            color: var(--primary-strong);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(15, 11, 5, 0.3);
        }

        /* Main content */
        .main-content {
            padding: 2rem 0;
            min-height: calc(100vh - 76px);
        }

        .welcome-card {
            background: linear-gradient(160deg, rgba(244, 232, 197, 0.92), rgba(255, 249, 230, 0.94));
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 40px rgba(15, 11, 5, 0.12);
        }

        .welcome-card h1 {
            font-family: 'Sora', sans-serif;
            font-size: 2rem;
            color: var(--panel);
            margin-bottom: 0.5rem;
        }

        .welcome-card p {
            color: var(--muted);
            margin-bottom: 0;
        }

        /* Management cards */
        .management-card {
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.75rem;
            transition: all 0.3s ease;
            height: 100%;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .management-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(255, 208, 46, 0.25);
            border-color: var(--primary-strong);
        }

        .management-card .icon {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--primary), var(--primary-strong));
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            color: var(--ink);
            margin-bottom: 1rem;
        }

        .management-card h3 {
            font-family: 'Sora', sans-serif;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--panel);
            margin-bottom: 0.5rem;
        }

        .management-card p {
            color: var(--muted);
            font-size: 0.9rem;
            margin-bottom: 0;
        }

        .management-card .arrow {
            margin-top: 1rem;
            color: var(--primary-strong);
            font-size: 1.25rem;
            transition: transform 0.2s ease;
        }

        .management-card:hover .arrow {
            transform: translateX(4px);
        }

        /* Section content */
        .section-header {
            background: linear-gradient(160deg, rgba(244, 232, 197, 0.92), rgba(255, 249, 230, 0.94));
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .section-header h2 {
            font-family: 'Sora', sans-serif;
            font-size: 1.75rem;
            color: var(--panel);
            margin-bottom: 0.5rem;
        }

        .section-header p {
            color: var(--muted);
            margin-bottom: 0;
        }

        .content-card {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 8px 24px rgba(15, 11, 5, 0.08);
        }

        /* Responsive adjustments */
        @media (max-width: 991px) {
            .navbar-collapse {
                background: rgba(255, 249, 230, 0.98);
                border-radius: 12px;
                padding: 1rem;
                margin-top: 1rem;
                border: 1px solid var(--border);
            }
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* M√©dicos Section Styles */
        .medicos-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--border);
            gap: 2rem;
        }

        .medicos-header h4 {
            font-family: 'Sora', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--panel);
            margin: 0;
        }

        .search-filter-bar {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-specialty {
            min-width: 220px;
        }

        .filter-specialty select {
            padding: 0.75rem 1rem;
            border-radius: 12px;
            border: 1.5px solid var(--border);
            font-family: 'Manrope', sans-serif;
            font-size: 0.95rem;
            background: rgba(255, 255, 255, 0.98);
            transition: all 0.25s ease;
        }

        .filter-specialty select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
        }

        .medicos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        .medico-card {
            background: rgba(255, 255, 255, 0.98);
            border: 1.5px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.25s ease;
            position: relative;
            overflow: hidden;
        }

        .medico-card:hover {
            transform: translateY(-4px);
            border-color: var(--primary);
            box-shadow: 0 8px 24px rgba(251, 191, 36, 0.15);
        }

        .medico-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 0;
            background: linear-gradient(180deg, var(--primary), var(--primary-strong));
            transition: width 0.25s ease;
        }

        .medico-card:hover::before {
            width: 4px;
        }

        .medico-avatar {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--primary), var(--primary-strong));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            color: var(--ink);
            font-weight: 700;
            margin-bottom: 1rem;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
        }

        .medico-name {
            font-family: 'Sora', sans-serif;
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--panel);
            margin-bottom: 0.25rem;
        }

        .medico-specialty {
            color: var(--primary-strong);
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .medico-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .medico-info-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--muted);
        }

        .medico-info-item i {
            color: var(--primary-strong);
            font-size: 1rem;
        }

        .medico-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .btn-back {
            background: transparent;
            border: 1.5px solid var(--border);
            color: var(--panel);
            padding: 0.75rem 1.25rem;
            border-radius: 10px;
            font-family: 'Manrope', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-back:hover {
            background: rgba(251, 191, 36, 0.05);
            border-color: var(--primary);
            transform: translateX(-4px);
        }

        @media (max-width: 768px) {
            .medicos-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .search-filter-bar {
                flex-direction: column;
                width: 100%;
            }

            .search-box,
            .filter-specialty {
                width: 100%;
                min-width: 100%;
            }

            .medicos-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <% const usernameQuery = name ? `?username=${encodeURIComponent(name)}` : '' ; %>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="/protected<%= usernameQuery %>">
                HEKO <span class="brand-accent">PORA</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link <%= section === 'dashboard' ? 'active' : '' %>" href="/protected<%= usernameQuery %>">
                            <i class="bi bi-speedometer2 me-1"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link <%= section === 'pacientes' ? 'active' : '' %>" href="/admin/pacientes<%= usernameQuery %>">
                            <i class="bi bi-people me-1"></i> Pacientes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link <%= section === 'medicos' ? 'active' : '' %>" href="/admin/medicos<%= usernameQuery %>">
                            <i class="bi bi-person-badge me-1"></i> M√©dicos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link <%= section === 'especialidades' ? 'active' : '' %>"
                            href="/admin/especialidades<%= usernameQuery %>">
                            <i class="bi bi-heart-pulse me-1"></i> Especialidades
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link <%= section === 'consultorios' ? 'active' : '' %>"
                            href="/admin/consultorios<%= usernameQuery %>">
                            <i class="bi bi-building me-1"></i> Consultorios
                        </a>
                    </li>
                </ul>
                <form action="/logout" method="POST" class="d-flex">
                    <button class="btn btn-logout" type="submit">
                        <i class="bi bi-box-arrow-right me-1"></i> Cerrar Sesi√≥n
                    </button>
                </form>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container">
            <% if (section==='dashboard' ) { %>
                <!-- Dashboard View -->
                <div class="welcome-card fade-in">
                    <h1>Bienvenido, <%= name %>
                    </h1>
                    <p>Sistema Web de Gesti√≥n de Consultorio centralizado</p>
                </div>

                <div class="row g-4">
                    <div class="col-md-6 col-lg-3">
                        <a href="/admin/pacientes<%= usernameQuery %>" class="management-card fade-in">
                            <div class="icon">
                                <i class="bi bi-people"></i>
                            </div>
                            <h3>Pacientes</h3>
                            <p>Gestiona el registro y datos de pacientes</p>
                            <div class="arrow">
                                <i class="bi bi-arrow-right"></i>
                            </div>
                        </a>
                    </div>

                    <div class="col-md-6 col-lg-3">
                        <a href="/admin/medicos<%= usernameQuery %>" class="management-card fade-in">
                            <div class="icon">
                                <i class="bi bi-person-badge"></i>
                            </div>
                            <h3>M√©dicos</h3>
                            <p>Administra profesionales y especialistas</p>
                            <div class="arrow">
                                <i class="bi bi-arrow-right"></i>
                            </div>
                        </a>
                    </div>

                    <div class="col-md-6 col-lg-3">
                        <a href="/admin/especialidades<%= usernameQuery %>" class="management-card fade-in">
                            <div class="icon">
                                <i class="bi bi-heart-pulse"></i>
                            </div>
                            <h3>Especialidades</h3>
                            <p>Configura especialidades m√©dicas</p>
                            <div class="arrow">
                                <i class="bi bi-arrow-right"></i>
                            </div>
                        </a>
                    </div>

                    <div class="col-md-6 col-lg-3">
                        <a href="/admin/consultorios<%= usernameQuery %>" class="management-card fade-in">
                            <div class="icon">
                                <i class="bi bi-building"></i>
                            </div>
                            <h3>Consultorios</h3>
                            <p>Gestiona salas y espacios m√©dicos</p>
                            <div class="arrow">
                                <i class="bi bi-arrow-right"></i>
                            </div>
                        </a>
                    </div>
                </div>

                <% } else if (section==='pacientes' ) { %>
                    <!-- Pacientes Section -->
                    <div class="section-header fade-in">
                        <h2><i class="bi bi-people me-2"></i> Gesti√≥n de Pacientes</h2>
                        <p>Administra el registro y datos de pacientes del centro m√©dico</p>
                    </div>
                    <div class="content-card fade-in">
                        <p class="text-muted">Aqu√≠ podr√°s gestionar toda la informaci√≥n de los pacientes.</p>
                        <!-- TODO: Add patient management table/forms here -->
                    </div>

                    <% } else if (section==='medicos' ) { %>
                        <!-- M√©dicos Section -->
                        <div class="section-header fade-in">
                            <h2><i class="bi bi-person-badge me-2"></i> Gesti√≥n de M√©dicos</h2>
                            <p>Administra profesionales m√©dicos y especialistas</p>
                        </div>

                        <!-- M√©dicos List View -->
                        <div id="medicosListView" class="content-card fade-in">
                            <div class="medicos-header">
                                <div>
                                    <h4><i class="bi bi-people-fill me-2"></i>M√©dicos Registrados</h4>
                                    <p class="text-muted mb-0"><span id="medicosCount">0</span> profesionales activos</p>
                                </div>
                                <button id="btnAgregarMedico" class="btn-primary-custom">
                                    <i class="bi bi-person-plus-fill me-2"></i>
                                    <span>Agregar M√©dico</span>
                                </button>
                            </div>

                            <div class="search-filter-bar mt-4">
                                <div class="search-box">
                                    <i class="bi bi-search"></i>
                                    <input type="text" id="searchMedico" placeholder="Buscar m√©dico..." />
                                </div>
                                <div class="filter-specialty">
                                    <select id="filterEspecialidad" class="form-control-custom">
                                        <option value="">Todas las especialidades</option>
                                    </select>
                                </div>
                            </div>

                            <div id="medicosList" class="medicos-grid mt-4">
                                <!-- M√©dicos cards will be inserted here -->
                                <div class="empty-state">
                                    <div class="empty-icon">
                                        <i class="bi bi-person-x"></i>
                                    </div>
                                    <p>No hay m√©dicos registrados</p>
                                    <small>Comienza agregando un nuevo profesional m√©dico</small>
                                </div>
                            </div>
                        </div>

                        <!-- M√©dicos Form View (hidden by default) -->
                        <div id="medicosFormView" class="content-card fade-in registro-medico-container" style="display: none;">
                            <!-- Back button -->
                            <button id="btnVolverLista" class="btn-back mb-3">
                                <i class="bi bi-arrow-left me-2"></i>
                                <span>Volver a la lista</span>
                            </button>

                            <!-- Registration Form -->
                            <div class="registro-medico-wrapper">
                                <div class="form-header">
                                    <div class="header-icon">
                                        <i class="bi bi-person-plus-fill"></i>
                                    </div>
                                    <h3>Registrar Nuevo M√©dico</h3>
                                    <p class="header-subtitle">Completa los datos del profesional m√©dico</p>
                                </div>

                                <form id="registroMedicoForm" class="registro-medico-form">
                                    <!-- Hidden field for edit mode -->
                                    <input type="hidden" id="medicoId" name="medicoId" value="">
                                    <!-- Personal Information Section -->
                                    <div class="form-section">
                                        <div class="section-title">
                                            <i class="bi bi-person-circle"></i>
                                            <span>Informaci√≥n Personal</span>
                                        </div>

                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <div class="form-floating-custom">
                                                    <input type="text" id="nombre" name="nombre" required
                                                           class="form-control-custom" placeholder=" ">
                                                    <label for="nombre">Nombre(s)</label>
                                                    <div class="input-border"></div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-floating-custom">
                                                    <input type="text" id="apellido" name="apellido" required
                                                           class="form-control-custom" placeholder=" ">
                                                    <label for="apellido">Apellido(s)</label>
                                                    <div class="input-border"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row g-3 mt-2">
                                            <div class="col-md-4">
                                                <div class="form-floating-custom">
                                                    <select id="tipoDocumento" name="tipoDocumento" required
                                                            class="form-control-custom tipo-documento-select">
                                                        <option value="" disabled selected></option>
                                                        <option value="cedula">ü™™ C√©dula</option>
                                                        <option value="dni">üÜî DNI</option>
                                                        <option value="pasaporte">üõÇ Pasaporte</option>
                                                    </select>
                                                    <label for="tipoDocumento">Tipo de Documento</label>
                                                    <div class="input-border"></div>
                                                    <small class="field-hint">Selecciona el tipo</small>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-floating-custom">
                                                    <input type="text" id="dni" name="dni" required
                                                           pattern="[0-9]{7,12}" class="form-control-custom" placeholder=" ">
                                                    <label for="dni">N√∫mero de Documento</label>
                                                    <div class="input-border"></div>
                                                    <small class="field-hint">Solo n√∫meros</small>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-floating-custom">
                                                    <input type="date" id="fechaNacimiento" name="fechaNacimiento"
                                                           required class="form-control-custom" placeholder=" "
                                                           max="<%= new Date().toISOString().split('T')[0] %>">
                                                    <label for="fechaNacimiento">Fecha de Nacimiento</label>
                                                    <div class="input-border"></div>
                                                    <small class="field-hint">No puede ser mayor a hoy</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Professional Information Section -->
                                    <div class="form-section">
                                        <div class="section-title">
                                            <i class="bi bi-briefcase-fill"></i>
                                            <span>Informaci√≥n Profesional</span>
                                        </div>

                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <div class="form-floating-custom">
                                                    <input type="text" id="matricula" name="matricula" required
                                                           class="form-control-custom" placeholder=" ">
                                                    <label for="matricula">Matr√≠cula Profesional</label>
                                                    <div class="input-border"></div>
                                                    <small class="field-hint">N√∫mero de matr√≠cula vigente</small>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-floating-custom">
                                                    <select id="especialidad" name="especialidad" required
                                                            class="form-control-custom">
                                                        <option value="" disabled selected></option>
                                                    </select>
                                                    <label for="especialidad">Especialidad M√©dica</label>
                                                    <div class="input-border"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row g-3 mt-2">
                                            <div class="col-12">
                                                <div class="form-floating-custom">
                                                    <input type="text" id="tituloProfesional" name="tituloProfesional"
                                                           required class="form-control-custom" placeholder=" ">
                                                    <label for="tituloProfesional">T√≠tulo Profesional</label>
                                                    <div class="input-border"></div>
                                                    <small class="field-hint">Ej: M√©dico Cirujano, Especialista en...</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Contact Information Section -->
                                    <div class="form-section">
                                        <div class="section-title">
                                            <i class="bi bi-envelope-at-fill"></i>
                                            <span>Datos de Contacto</span>
                                        </div>

                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <div class="form-floating-custom">
                                                    <input type="email" id="email" name="email" required
                                                           class="form-control-custom" placeholder=" ">
                                                    <label for="email">Correo Electr√≥nico</label>
                                                    <div class="input-border"></div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-floating-custom">
                                                    <input type="tel" id="telefono" name="telefono" required
                                                           pattern="[0-9]{10}" class="form-control-custom" placeholder=" ">
                                                    <label for="telefono">Tel√©fono / Celular</label>
                                                    <div class="input-border"></div>
                                                    <small class="field-hint">10 d√≠gitos sin espacios</small>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row g-3 mt-2">
                                            <div class="col-12">
                                                <div class="form-floating-custom">
                                                    <textarea id="direccion" name="direccion" required
                                                              class="form-control-custom textarea-custom"
                                                              placeholder=" " rows="3"></textarea>
                                                    <label for="direccion">Direcci√≥n</label>
                                                    <div class="input-border"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Schedule and Availability Section -->
                                    <div class="form-section">
                                        <div class="section-title">
                                            <i class="bi bi-clock-fill"></i>
                                            <span>Horarios de Atenci√≥n</span>
                                        </div>

                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <div class="form-floating-custom">
                                                    <input type="time" id="horaInicio" name="horaInicio"
                                                           required class="form-control-custom" placeholder=" ">
                                                    <label for="horaInicio">Hora de Inicio</label>
                                                    <div class="input-border"></div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-floating-custom">
                                                    <input type="time" id="horaFin" name="horaFin"
                                                           required class="form-control-custom" placeholder=" ">
                                                    <label for="horaFin">Hora de Finalizaci√≥n</label>
                                                    <div class="input-border"></div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="dias-atencion mt-3">
                                            <label class="dias-label">D√≠as de Atenci√≥n</label>
                                            <div class="dias-grid">
                                                <div class="dia-checkbox">
                                                    <input type="checkbox" id="lunes" name="dias[]" value="lunes">
                                                    <label for="lunes">Lunes</label>
                                                </div>
                                                <div class="dia-checkbox">
                                                    <input type="checkbox" id="martes" name="dias[]" value="martes">
                                                    <label for="martes">Martes</label>
                                                </div>
                                                <div class="dia-checkbox">
                                                    <input type="checkbox" id="miercoles" name="dias[]" value="miercoles">
                                                    <label for="miercoles">Mi√©rcoles</label>
                                                </div>
                                                <div class="dia-checkbox">
                                                    <input type="checkbox" id="jueves" name="dias[]" value="jueves">
                                                    <label for="jueves">Jueves</label>
                                                </div>
                                                <div class="dia-checkbox">
                                                    <input type="checkbox" id="viernes" name="dias[]" value="viernes">
                                                    <label for="viernes">Viernes</label>
                                                </div>
                                                <div class="dia-checkbox">
                                                    <input type="checkbox" id="sabado" name="dias[]" value="sabado">
                                                    <label for="sabado">S√°bado</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Form Actions -->
                                    <div class="form-actions">
                                        <button type="button" class="btn-secondary-custom">
                                            <i class="bi bi-x-circle me-2"></i>
                                            <span>Cancelar</span>
                                        </button>
                                        <button type="submit" class="btn-primary-custom">
                                            <i class="bi bi-check-circle me-2"></i>
                                            <span>Registrar M√©dico</span>
                                        </button>
                                    </div>
                                </form>

                                <!-- Success/Error Message -->
                                <div id="formMessage" class="form-message" style="display: none;"></div>
                            </div>
                        </div>

                        <% } else if (section==='especialidades' ) { %>
                            <!-- Especialidades Section -->
                            <div class="section-header fade-in">
                                <h2><i class="bi bi-heart-pulse me-2"></i> Gesti√≥n de Especialidades M√©dicas</h2>
                                <p>Configura y administra las especialidades disponibles en el centro m√©dico</p>
                            </div>

                            <div class="content-card fade-in especialidades-container">
                                <!-- Dual Panel Layout -->
                                <div class="especialidades-grid">
                                    <!-- Left Panel: Add New Specialty -->
                                    <div class="specialty-form-panel">
                                        <div class="panel-header">
                                            <div class="header-icon-small">
                                                <i class="bi bi-plus-circle-fill"></i>
                                            </div>
                                            <h4>Nueva Especialidad</h4>
                                            <p class="panel-subtitle">Registra una nueva especialidad m√©dica</p>
                                        </div>

                                        <form id="especialidadForm" class="specialty-form">
                                            <!-- Hidden field for edit mode -->
                                            <input type="hidden" id="especialidadId" name="especialidadId" value="">

                                            <div class="form-floating-custom">
                                                <input type="text" id="nombreEspecialidad" name="nombre" required
                                                       class="form-control-custom" placeholder=" " maxlength="100">
                                                <label for="nombreEspecialidad">Nombre de la Especialidad</label>
                                                <div class="input-border"></div>
                                                <small class="field-hint">Ej: Cardiolog√≠a, Pediatr√≠a, Neurolog√≠a</small>
                                            </div>

                                            <div class="form-actions-inline mt-4">
                                                <button type="submit" class="btn-primary-custom">
                                                    <i class="bi bi-check-circle me-2"></i>
                                                    <span>Agregar Especialidad</span>
                                                </button>
                                                <button type="button" class="btn-secondary-custom" onclick="resetEspecialidadForm()">
                                                    <i class="bi bi-arrow-clockwise me-2"></i>
                                                    <span>Limpiar</span>
                                                </button>
                                            </div>
                                        </form>

                                        <div id="specialtyFormMessage" class="form-message" style="display: none;"></div>
                                    </div>

                                    <!-- Right Panel: Specialties List -->
                                    <div class="specialty-list-panel">
                                        <div class="panel-header">
                                            <div class="header-flex">
                                                <div>
                                                    <div class="header-icon-small">
                                                        <i class="bi bi-list-ul"></i>
                                                    </div>
                                                    <h4>Especialidades Registradas</h4>
                                                    <p class="panel-subtitle">
                                                        <span id="specialtyCount">0</span> especialidades activas
                                                    </p>
                                                </div>
                                                <div class="search-box">
                                                    <i class="bi bi-search"></i>
                                                    <input type="text" id="searchSpecialty" placeholder="Buscar..." />
                                                </div>
                                            </div>
                                        </div>

                                        <div id="specialtiesList" class="specialties-list">
                                            <!-- Specialty cards will be inserted here dynamically -->
                                            <div class="empty-state">
                                                <div class="empty-icon">
                                                    <i class="bi bi-inbox"></i>
                                                </div>
                                                <p>No hay especialidades registradas</p>
                                                <small>Comienza agregando una nueva especialidad</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <% } else if (section==='consultorios' ) { %>
                                <!-- Consultorios Section -->
                                <div class="section-header fade-in">
                                    <h2><i class="bi bi-building me-2"></i> Gesti√≥n de Consultorios</h2>
                                    <p>Administra salas y espacios de consulta m√©dica</p>
                                </div>
                                <div class="content-card fade-in">
                                    <p class="text-muted">Aqu√≠ podr√°s gestionar los consultorios y salas disponibles.
                                    </p>
                                    <!-- TODO: Add consultation room management table/forms here -->
                                </div>

                                <% } %>
        </div>
    </div>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Especialidades Interactive Script -->
    <script>
        // Especialidades Management
        const especialidadesDB = [];

        function initEspecialidades() {
            const especialidadForm = document.getElementById('especialidadForm');
            const searchInput = document.getElementById('searchSpecialty');
            const specialtyFormMessage = document.getElementById('specialtyFormMessage');

            if (especialidadForm) {
                // Form submission
                especialidadForm.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    const nombre = document.getElementById('nombreEspecialidad').value.trim();
                    const especialidadId = document.getElementById('especialidadId').value;
                    const isEditMode = especialidadId && especialidadId !== '';

                    // Add loading state
                    const submitBtn = especialidadForm.querySelector('.btn-primary-custom');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = `<span style="opacity: 0.6;">${isEditMode ? 'Actualizando...' : 'Agregando...'}</span>`;
                    submitBtn.disabled = true;

                    try {
                        // Choose endpoint and method based on mode
                        const url = isEditMode ? `/api/especialidades/${especialidadId}` : '/api/especialidades';
                        const method = isEditMode ? 'PUT' : 'POST';

                        const response = await fetch(url, {
                            method: method,
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ nombre })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            await loadEspecialidades();
                            especialidadForm.reset();
                            document.getElementById('especialidadId').value = '';

                            // Reset form title
                            const formTitle = especialidadForm.closest('.specialty-form-panel').querySelector('h4');
                            if (formTitle) {
                                formTitle.textContent = 'Nueva Especialidad';
                            }

                            // Reset button text
                            submitBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i><span>Agregar Especialidad</span>';

                            showSpecialtyMessage(isEditMode ? '‚úì Especialidad actualizada exitosamente' : '‚úì Especialidad agregada exitosamente', 'success');
                        } else {
                            showSpecialtyMessage('Error: ' + data.error, 'error');
                        }
                    } catch (error) {
                        showSpecialtyMessage(`Error al ${isEditMode ? 'actualizar' : 'agregar'} especialidad: ` + error.message, 'error');
                    } finally {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }
                });
            }

            // Search functionality
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    renderEspecialidades(this.value.toLowerCase());
                });
            }

            // Load data from API
            loadEspecialidades();
        }

        async function loadEspecialidades() {
            try {
                const response = await fetch('/api/especialidades');
                const data = await response.json();

                especialidadesDB.length = 0;
                especialidadesDB.push(...data.map(esp => ({
                    id: esp.ID_ESPECIALIDAD,
                    nombre: esp.NOMBRE,
                    fechaCreacion: new Date().toLocaleDateString('es-AR')
                })));

                renderEspecialidades();
            } catch (error) {
                console.error('Error al cargar especialidades:', error);
            }
        }

        function renderEspecialidades(searchTerm = '') {
            const listContainer = document.getElementById('specialtiesList');
            const countElement = document.getElementById('specialtyCount');

            if (!listContainer) return;

            const filtered = especialidadesDB.filter(esp =>
                esp.nombre.toLowerCase().includes(searchTerm)
            );

            if (countElement) {
                countElement.textContent = filtered.length;
            }

            if (filtered.length === 0) {
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="bi bi-inbox"></i>
                        </div>
                        <p>${searchTerm ? 'No se encontraron resultados' : 'No hay especialidades registradas'}</p>
                        <small>${searchTerm ? 'Intenta con otros t√©rminos de b√∫squeda' : 'Comienza agregando una nueva especialidad'}</small>
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = filtered.map((esp, index) => `
                <div class="specialty-card" style="animation-delay: ${index * 0.05}s">
                    <div class="specialty-info">
                        <h5>${esp.nombre}</h5>
                        <small class="specialty-meta">
                            <i class="bi bi-calendar3"></i> Registrada el ${esp.fechaCreacion}
                        </small>
                    </div>
                    <div class="specialty-actions">
                        <button class="btn-icon-action" title="Editar" onclick="editSpecialty(${esp.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn-icon-action danger" title="Eliminar" onclick="deleteSpecialty(${esp.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function resetEspecialidadForm() {
            const form = document.getElementById('especialidadForm');
            if (form) {
                form.reset();
                document.getElementById('especialidadId').value = '';

                // Reset form title
                const formTitle = document.querySelector('.specialty-form-panel h4');
                if (formTitle) {
                    formTitle.textContent = 'Nueva Especialidad';
                }

                // Reset submit button text
                const submitBtn = form.querySelector('.btn-primary-custom');
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i><span>Agregar Especialidad</span>';
                }
            }
        }

        function editSpecialty(id) {
            const specialty = especialidadesDB.find(e => e.id === id);
            if (specialty) {
                // Set the specialty ID for edit mode
                document.getElementById('especialidadId').value = specialty.id;

                // Fill the form
                document.getElementById('nombreEspecialidad').value = specialty.nombre;

                // Update form title
                const formTitle = document.querySelector('.specialty-form-panel h4');
                if (formTitle) {
                    formTitle.textContent = 'Editar Especialidad';
                }

                // Update submit button text
                const submitBtn = document.querySelector('#especialidadForm .btn-primary-custom');
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="bi bi-pencil me-2"></i><span>Actualizar Especialidad</span>';
                }

                // Focus on the input
                document.getElementById('nombreEspecialidad').focus();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        async function deleteSpecialty(id) {
            if (confirm('¬øEst√°s seguro de eliminar esta especialidad?')) {
                try {
                    const response = await fetch(`/api/especialidades/${id}`, {
                        method: 'DELETE'
                    });

                    const data = await response.json();

                    if (response.ok) {
                        await loadEspecialidades();
                        showSpecialtyMessage('Especialidad eliminada', 'success');
                    } else {
                        showSpecialtyMessage('Error: ' + data.error, 'error');
                    }
                } catch (error) {
                    showSpecialtyMessage('Error al eliminar especialidad: ' + error.message, 'error');
                }
            }
        }

        function showSpecialtyMessage(message, type) {
            const messageEl = document.getElementById('specialtyFormMessage');
            if (messageEl) {
                messageEl.textContent = message;
                messageEl.className = 'form-message ' + type;
                messageEl.style.display = 'block';

                setTimeout(() => {
                    messageEl.style.opacity = '0';
                    setTimeout(() => {
                        messageEl.style.display = 'none';
                        messageEl.style.opacity = '1';
                    }, 300);
                }, 3000);
            }
        }
    </script>

    <!-- M√©dicos Management Script -->
    <script>
        // M√©dicos database
        const medicosDB = [];

        async function loadEspecialidadesForMedicos() {
            try {
                const response = await fetch('/api/especialidades');
                const especialidades = await response.json();

                // Cargar en el filtro de especialidades
                const filterSelect = document.getElementById('filterEspecialidad');
                if (filterSelect) {
                    const currentValue = filterSelect.value;
                    filterSelect.innerHTML = '<option value="">Todas las especialidades</option>';
                    especialidades.forEach(esp => {
                        const option = document.createElement('option');
                        option.value = esp.ID_ESPECIALIDAD;
                        option.textContent = esp.NOMBRE;
                        filterSelect.appendChild(option);
                    });
                    filterSelect.value = currentValue;
                }

                // Cargar en el formulario de registro
                const formSelect = document.getElementById('especialidad');
                if (formSelect) {
                    const currentValue = formSelect.value;
                    formSelect.innerHTML = '<option value="" disabled selected></option>';
                    especialidades.forEach(esp => {
                        const option = document.createElement('option');
                        option.value = esp.ID_ESPECIALIDAD;
                        option.textContent = esp.NOMBRE;
                        formSelect.appendChild(option);
                    });
                    if (currentValue) formSelect.value = currentValue;
                }
            } catch (error) {
                console.error('Error al cargar especialidades:', error);
            }
        }

        function initMedicos() {
            const btnAgregarMedico = document.getElementById('btnAgregarMedico');
            const btnVolverLista = document.getElementById('btnVolverLista');
            const searchInput = document.getElementById('searchMedico');
            const filterEspecialidad = document.getElementById('filterEspecialidad');
            const medicosListView = document.getElementById('medicosListView');
            const medicosFormView = document.getElementById('medicosFormView');

            // Cargar especialidades primero
            loadEspecialidadesForMedicos();

            if (btnAgregarMedico) {
                btnAgregarMedico.addEventListener('click', function() {
                    // Reset form for new medico
                    const form = document.getElementById('registroMedicoForm');
                    if (form) {
                        form.reset();
                        document.getElementById('medicoId').value = '';

                        // Reset all checkboxes
                        const checkboxes = form.querySelectorAll('input[type="checkbox"]');
                        checkboxes.forEach(cb => cb.checked = false);

                        // Reset form title
                        const formHeader = document.querySelector('.form-header h3');
                        if (formHeader) {
                            formHeader.textContent = 'Registrar Nuevo M√©dico';
                        }

                        // Reset submit button text
                        const submitBtn = form.querySelector('.btn-primary-custom');
                        if (submitBtn) {
                            submitBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i><span>Registrar M√©dico</span>';
                        }
                    }

                    medicosListView.style.display = 'none';
                    medicosFormView.style.display = 'block';
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            }

            if (btnVolverLista) {
                btnVolverLista.addEventListener('click', function() {
                    // Reset form when going back
                    const form = document.getElementById('registroMedicoForm');
                    if (form) {
                        form.reset();
                        document.getElementById('medicoId').value = '';

                        // Reset all checkboxes
                        const checkboxes = form.querySelectorAll('input[type="checkbox"]');
                        checkboxes.forEach(cb => cb.checked = false);

                        // Reset form title
                        const formHeader = document.querySelector('.form-header h3');
                        if (formHeader) {
                            formHeader.textContent = 'Registrar Nuevo M√©dico';
                        }

                        // Reset submit button text
                        const submitBtn = form.querySelector('.btn-primary-custom');
                        if (submitBtn) {
                            submitBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i><span>Registrar M√©dico</span>';
                        }
                    }

                    medicosFormView.style.display = 'none';
                    medicosListView.style.display = 'block';
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            }

            // Search functionality
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const specialty = filterEspecialidad ? filterEspecialidad.value : '';
                    renderMedicos(this.value.toLowerCase(), specialty);
                });
            }

            // Filter functionality
            if (filterEspecialidad) {
                filterEspecialidad.addEventListener('change', function() {
                    const search = searchInput ? searchInput.value.toLowerCase() : '';
                    renderMedicos(search, this.value);
                });
            }

            // Load data from API
            loadMedicos();
        }

        async function loadMedicos() {
            try {
                const response = await fetch('/api/medicos');
                const data = await response.json();

                medicosDB.length = 0;
                medicosDB.push(...data.map(medico => {
                    // Formatear fecha de nacimiento
                    let fechaNacimiento = 'No disponible';
                    if (medico.FECHA_NACIMIENTO) {
                        const fecha = new Date(medico.FECHA_NACIMIENTO);
                        fechaNacimiento = fecha.toLocaleDateString('es-AR');
                    }

                    // Calcular edad
                    let edad = '';
                    if (medico.FECHA_NACIMIENTO) {
                        const hoy = new Date();
                        const nacimiento = new Date(medico.FECHA_NACIMIENTO);
                        let edadCalculada = hoy.getFullYear() - nacimiento.getFullYear();
                        const mes = hoy.getMonth() - nacimiento.getMonth();
                        if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) {
                            edadCalculada--;
                        }
                        edad = `${edadCalculada} a√±os`;
                    }

                    // Formatear horario de atenci√≥n
                    let horario = 'Horario no configurado';
                    let diasAtencion = [];
                    if (medico.HORA_INICIO && medico.HORA_FIN) {
                        // Formatear las horas (eliminar segundos si existen)
                        const horaInicio = medico.HORA_INICIO.substring(0, 5);
                        const horaFin = medico.HORA_FIN.substring(0, 5);
                        horario = `${horaInicio} - ${horaFin}`;

                        if (medico.DIAS_ATENCION) {
                            diasAtencion = medico.DIAS_ATENCION.split(',');
                        }
                    }

                    return {
                        id: medico.ID_MEDICO,
                        nombre: medico.NOMBRE,
                        apellido: medico.APELLIDO,
                        dni: medico.NRO_DOCUMENTO,
                        tipoDocumento: medico.TIPO_DOCUMENTO,
                        fechaNacimiento: fechaNacimiento,
                        edad: edad,
                        especialidad: medico.ID_ESPECIALIDAD,
                        especialidadNombre: medico.ESPECIALIDAD_NOMBRE || 'Sin especialidad',
                        matricula: medico.MATRICULA,
                        email: medico.EMAIL || 'Sin email',
                        telefono: medico.TELEFONO || 'Sin tel√©fono',
                        horario: horario,
                        diasAtencion: diasAtencion,
                        horaInicio: medico.HORA_INICIO ? medico.HORA_INICIO.substring(0, 5) : '',
                        horaFin: medico.HORA_FIN ? medico.HORA_FIN.substring(0, 5) : ''
                    };
                }));

                renderMedicos();
            } catch (error) {
                console.error('Error al cargar m√©dicos:', error);
            }
        }

        function renderMedicos(searchTerm = '', specialtyFilter = '') {
            const listContainer = document.getElementById('medicosList');
            const countElement = document.getElementById('medicosCount');

            if (!listContainer) return;

            const filtered = medicosDB.filter(medico => {
                const matchesSearch =
                    medico.nombre.toLowerCase().includes(searchTerm) ||
                    medico.apellido.toLowerCase().includes(searchTerm) ||
                    medico.matricula.toLowerCase().includes(searchTerm);
                const matchesSpecialty = !specialtyFilter || medico.especialidad === specialtyFilter;
                return matchesSearch && matchesSpecialty;
            });

            if (countElement) {
                countElement.textContent = filtered.length;
            }

            if (filtered.length === 0) {
                listContainer.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-icon">
                            <i class="bi bi-person-x"></i>
                        </div>
                        <p>${searchTerm || specialtyFilter ? 'No se encontraron m√©dicos' : 'No hay m√©dicos registrados'}</p>
                        <small>${searchTerm || specialtyFilter ? 'Intenta con otros criterios de b√∫squeda' : 'Comienza agregando un nuevo profesional m√©dico'}</small>
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = filtered.map(medico => {
                const initials = `${medico.nombre.charAt(0)}${medico.apellido.charAt(0)}`.toUpperCase();

                // Formatear d√≠as de atenci√≥n
                let diasTexto = '';
                if (medico.diasAtencion && medico.diasAtencion.length > 0) {
                    const diasMap = {
                        'lunes': 'Lun',
                        'martes': 'Mar',
                        'miercoles': 'Mi√©',
                        'jueves': 'Jue',
                        'viernes': 'Vie',
                        'sabado': 'S√°b',
                        'domingo': 'Dom'
                    };
                    diasTexto = medico.diasAtencion.map(d => diasMap[d] || d).join(', ');
                }

                return `
                    <div class="medico-card">
                        <div class="medico-avatar">${initials}</div>
                        <div class="medico-name">Dr. ${medico.nombre} ${medico.apellido}</div>
                        <div class="medico-specialty">${medico.especialidadNombre || 'Sin especialidad'}</div>
                        <div class="medico-info">
                            <div class="medico-info-item">
                                <i class="bi bi-card-text"></i>
                                <span>Mat. ${medico.matricula}</span>
                            </div>
                            <div class="medico-info-item">
                                <i class="bi bi-clock"></i>
                                <span>${medico.horario}</span>
                            </div>
                            ${diasTexto ? `<div class="medico-info-item">
                                <i class="bi bi-calendar-week"></i>
                                <span>${diasTexto}</span>
                            </div>` : ''}
                            <div class="medico-info-item">
                                <i class="bi bi-envelope"></i>
                                <span>${medico.email}</span>
                            </div>
                            <div class="medico-info-item">
                                <i class="bi bi-telephone"></i>
                                <span>${medico.telefono}</span>
                            </div>
                        </div>
                        <div class="medico-actions">
                            <button class="btn-icon-action" title="Ver detalles" onclick="viewMedico(${medico.id})">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn-icon-action" title="Editar" onclick="editMedico(${medico.id})">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn-icon-action danger" title="Eliminar" onclick="deleteMedico(${medico.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function viewMedico(id) {
            const medico = medicosDB.find(m => m.id === id);
            if (medico) {
                // Formatear d√≠as de atenci√≥n
                let diasTexto = 'No configurado';
                if (medico.diasAtencion && medico.diasAtencion.length > 0) {
                    const diasMap = {
                        'lunes': 'Lunes',
                        'martes': 'Martes',
                        'miercoles': 'Mi√©rcoles',
                        'jueves': 'Jueves',
                        'viernes': 'Viernes',
                        'sabado': 'S√°bado',
                        'domingo': 'Domingo'
                    };
                    diasTexto = medico.diasAtencion.map(d => diasMap[d] || d).join(', ');
                }

                const detalles = `
Detalles de Dr. ${medico.nombre} ${medico.apellido}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üìã Informaci√≥n Personal
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ Documento: ${medico.tipoDocumento.toUpperCase()} ${medico.dni}
‚Ä¢ Fecha de Nacimiento: ${medico.fechaNacimiento}
${medico.edad ? '‚Ä¢ Edad: ' + medico.edad : ''}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üíº Informaci√≥n Profesional
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ Especialidad: ${medico.especialidadNombre}
‚Ä¢ Matr√≠cula: ${medico.matricula}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üïê Horario de Atenci√≥n
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ Horario: ${medico.horario}
‚Ä¢ D√≠as: ${diasTexto}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üìû Contacto
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ Email: ${medico.email}
‚Ä¢ Tel√©fono: ${medico.telefono}
                `.trim();
                alert(detalles);
            }
        }

        function editMedico(id) {
            const medico = medicosDB.find(m => m.id === id);
            if (medico) {
                // Show form view
                document.getElementById('medicosListView').style.display = 'none';
                document.getElementById('medicosFormView').style.display = 'block';

                // Set the medico ID for edit mode
                document.getElementById('medicoId').value = medico.id;

                // Update form title
                const formHeader = document.querySelector('.form-header h3');
                if (formHeader) {
                    formHeader.textContent = 'Editar M√©dico';
                }

                // Update submit button text
                const submitBtn = document.querySelector('#registroMedicoForm .btn-primary-custom');
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i><span>Actualizar M√©dico</span>';
                }

                // Fill form with data
                document.getElementById('nombre').value = medico.nombre;
                document.getElementById('apellido').value = medico.apellido;
                document.getElementById('tipoDocumento').value = medico.tipoDocumento;
                document.getElementById('dni').value = medico.dni;

                // Convertir fecha al formato YYYY-MM-DD para el input type="date"
                if (medico.fechaNacimiento && medico.fechaNacimiento !== 'No disponible') {
                    const partes = medico.fechaNacimiento.split('/');
                    if (partes.length === 3) {
                        const fechaISO = `${partes[2]}-${partes[1].padStart(2, '0')}-${partes[0].padStart(2, '0')}`;
                        document.getElementById('fechaNacimiento').value = fechaISO;
                    }
                }

                document.getElementById('matricula').value = medico.matricula;
                document.getElementById('especialidad').value = medico.especialidad;
                document.getElementById('email').value = medico.email;
                document.getElementById('telefono').value = medico.telefono;

                // Cargar horarios
                if (medico.horaInicio) {
                    document.getElementById('horaInicio').value = medico.horaInicio;
                }
                if (medico.horaFin) {
                    document.getElementById('horaFin').value = medico.horaFin;
                }

                // Cargar d√≠as de atenci√≥n
                if (medico.diasAtencion && medico.diasAtencion.length > 0) {
                    medico.diasAtencion.forEach(dia => {
                        const checkbox = document.getElementById(dia);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                }

                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        async function deleteMedico(id) {
            if (confirm('¬øEst√°s seguro de eliminar este m√©dico?')) {
                try {
                    const response = await fetch(`/api/medicos/${id}`, {
                        method: 'DELETE'
                    });

                    const data = await response.json();

                    if (response.ok) {
                        await loadMedicos();
                    } else {
                        alert('Error al eliminar m√©dico: ' + data.error);
                    }
                } catch (error) {
                    alert('Error al eliminar m√©dico: ' + error.message);
                }
            }
        }
    </script>

    <!-- Registro M√©dico Interactive Script -->
    <script>
        // Form validation and interactivity
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize medicos if on that section
            if (document.getElementById('medicosListView')) {
                initMedicos();
            }

            // Initialize especialidades if on that section
            if (document.getElementById('especialidadForm')) {
                initEspecialidades();
            }
            const registroForm = document.getElementById('registroMedicoForm');
            const formMessage = document.getElementById('formMessage');

            if (registroForm) {
                // Tipo de documento interactivity
                const tipoDocSelect = document.getElementById('tipoDocumento');
                const dniInput = document.getElementById('dni');
                const dniHint = dniInput?.parentElement.querySelector('.field-hint');

                if (tipoDocSelect && dniInput) {
                    tipoDocSelect.addEventListener('change', function() {
                        const tipo = this.value;

                        // Add highlight animation
                        dniInput.classList.add('documento-field-highlight');
                        setTimeout(() => {
                            dniInput.classList.remove('documento-field-highlight');
                        }, 600);

                        switch(tipo) {
                            case 'cedula':
                                dniInput.setAttribute('pattern', '[0-9]{7,8}');
                                dniInput.setAttribute('maxlength', '8');
                                if (dniHint) dniHint.textContent = '7-8 d√≠gitos';
                                break;
                            case 'dni':
                                dniInput.setAttribute('pattern', '[0-9]{7,8}');
                                dniInput.setAttribute('maxlength', '8');
                                if (dniHint) dniHint.textContent = '7-8 d√≠gitos';
                                break;
                            case 'pasaporte':
                                dniInput.setAttribute('pattern', '[A-Z0-9]{6,12}');
                                dniInput.removeAttribute('maxlength');
                                if (dniHint) dniHint.textContent = 'Letras y n√∫meros';
                                break;
                        }
                        dniInput.value = '';
                        dniInput.focus();
                    });
                }

                // Add smooth focus animations to inputs
                const inputs = registroForm.querySelectorAll('.form-control-custom');
                inputs.forEach(input => {
                    // Auto-format DNI input based on document type
                    if (input.id === 'dni') {
                        input.addEventListener('input', function(e) {
                            const tipoDoc = tipoDocSelect?.value;
                            if (tipoDoc === 'pasaporte') {
                                this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '').slice(0, 12);
                            } else {
                                this.value = this.value.replace(/\D/g, '').slice(0, 8);
                            }
                        });
                    }

                    // Auto-format phone input
                    if (input.id === 'telefono') {
                        input.addEventListener('input', function(e) {
                            this.value = this.value.replace(/\D/g, '').slice(0, 10);
                        });
                    }

                    // Auto-format matricula input (only numbers)
                    if (input.id === 'matricula') {
                        input.addEventListener('input', function(e) {
                            this.value = this.value.replace(/\D/g, '');
                        });
                    }

                    // Add ripple effect on focus
                    input.addEventListener('focus', function() {
                        this.parentElement.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                        this.parentElement.style.transform = 'scale(1.01)';
                    });

                    input.addEventListener('blur', function() {
                        this.parentElement.style.transform = 'scale(1)';
                    });
                });

                // Checkbox interactions
                const checkboxes = registroForm.querySelectorAll('.dia-checkbox input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const label = this.nextElementSibling;
                        if (this.checked) {
                            // Stagger animation for visual feedback
                            label.style.animation = 'none';
                            setTimeout(() => {
                                label.style.animation = 'pulse 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
                            }, 10);
                        }
                    });
                });

                // Form submission handler
                registroForm.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    // Check if we're in edit mode
                    const medicoId = document.getElementById('medicoId').value;
                    const isEditMode = medicoId && medicoId !== '';

                    // Add loading state
                    registroForm.classList.add('form-loading');
                    const submitBtn = registroForm.querySelector('.btn-primary-custom');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = `<span style="opacity: 0.6;">${isEditMode ? 'Actualizando...' : 'Registrando...'}</span>`;

                    // Validate at least one day is selected
                    const diasSeleccionados = registroForm.querySelectorAll('input[name="dias[]"]:checked');
                    if (diasSeleccionados.length === 0) {
                        showMessage('Por favor selecciona al menos un d√≠a de atenci√≥n', 'error');
                        registroForm.classList.remove('form-loading');
                        submitBtn.innerHTML = originalText;
                        return;
                    }

                    // Collect form data
                    const formData = new FormData(registroForm);
                    const data = {};

                    // Convert FormData to object
                    for (let [key, value] of formData.entries()) {
                        if (key === 'dias[]') {
                            if (!data.dias) data.dias = [];
                            data.dias.push(value);
                        } else {
                            data[key] = value;
                        }
                    }

                    // Validate required numeric fields
                    if (!data.dni || data.dni.trim() === '') {
                        showMessage('El n√∫mero de documento es requerido', 'error');
                        registroForm.classList.remove('form-loading');
                        submitBtn.innerHTML = originalText;
                        return;
                    }

                    if (!data.matricula || data.matricula.trim() === '') {
                        showMessage('La matr√≠cula profesional es requerida', 'error');
                        registroForm.classList.remove('form-loading');
                        submitBtn.innerHTML = originalText;
                        return;
                    }

                    if (!data.especialidad || data.especialidad === '') {
                        showMessage('Debes seleccionar una especialidad', 'error');
                        registroForm.classList.remove('form-loading');
                        submitBtn.innerHTML = originalText;
                        return;
                    }

                    try {
                        // Prepare data for API
                        const medicoData = {
                            nombre: data.nombre,
                            apellido: data.apellido,
                            tipoDocumento: data.tipoDocumento,
                            nroDocumento: parseInt(data.dni),
                            fechaNacimiento: data.fechaNacimiento,
                            matricula: parseInt(data.matricula),
                            idEspecialidad: parseInt(data.especialidad),
                            email: data.email,
                            telefono: data.telefono,
                            idSucursal: null,
                            horaInicio: data.horaInicio,
                            horaFin: data.horaFin,
                            diasAtencion: data.dias ? data.dias.join(',') : null
                        };

                        console.log('Datos a enviar:', medicoData);
                        console.log('Modo edici√≥n:', isEditMode);

                        // Choose endpoint and method based on mode
                        const url = isEditMode ? `/api/medicos/${medicoId}` : '/api/medicos';
                        const method = isEditMode ? 'PUT' : 'POST';

                        const response = await fetch(url, {
                            method: method,
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(medicoData)
                        });

                        const result = await response.json();

                        if (response.ok) {
                            // Show success message
                            showMessage(isEditMode ? '¬°M√©dico actualizado exitosamente!' : '¬°M√©dico registrado exitosamente!', 'success');

                            // Reset form and go back to list after success
                            setTimeout(() => {
                                registroForm.reset();
                                checkboxes.forEach(cb => cb.checked = false);
                                document.getElementById('medicoId').value = '';

                                // Go back to list view and reload data
                                document.getElementById('medicosFormView').style.display = 'none';
                                document.getElementById('medicosListView').style.display = 'block';
                                loadMedicos();
                                window.scrollTo({ top: 0, behavior: 'smooth' });
                            }, 1500);
                        } else {
                            showMessage('Error: ' + result.error, 'error');
                        }
                    } catch (error) {
                        showMessage(`Error al ${isEditMode ? 'actualizar' : 'registrar'} m√©dico: ` + error.message, 'error');
                    } finally {
                        registroForm.classList.remove('form-loading');
                        submitBtn.innerHTML = originalText;
                    }
                });

                // Cancel button handler
                const cancelBtn = registroForm.querySelector('.btn-secondary-custom');
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', function() {
                        if (confirm('¬øEst√°s seguro de cancelar el registro? Se perder√°n los datos ingresados.')) {
                            registroForm.reset();
                            checkboxes.forEach(cb => cb.checked = false);
                            formMessage.style.display = 'none';

                            // Go back to list view if exists
                            const medicosFormView = document.getElementById('medicosFormView');
                            const medicosListView = document.getElementById('medicosListView');
                            if (medicosFormView && medicosListView) {
                                medicosFormView.style.display = 'none';
                                medicosListView.style.display = 'block';
                            }

                            // Scroll to top smoothly
                            window.scrollTo({
                                top: 0,
                                behavior: 'smooth'
                            });
                        }
                    });
                }

                // Show message helper
                function showMessage(message, type) {
                    formMessage.textContent = message;
                    formMessage.className = 'form-message ' + type;
                    formMessage.style.display = 'block';

                    // Scroll to message
                    formMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                    // Auto-hide success messages
                    if (type === 'success') {
                        setTimeout(() => {
                            formMessage.style.opacity = '0';
                            setTimeout(() => {
                                formMessage.style.display = 'none';
                                formMessage.style.opacity = '1';
                            }, 300);
                        }, 5000);
                    }
                }

                // Add pulse animation for checkboxes
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes pulse {
                        0% { transform: scale(1); }
                        50% { transform: scale(1.08); }
                        100% { transform: scale(1.05); }
                    }
                `;
                document.head.appendChild(style);
            }

            // Add parallax effect to ambient glows (optional enhancement)
            const container = document.querySelector('.registro-medico-container');
            if (container && window.innerWidth > 768) {
                document.addEventListener('mousemove', function(e) {
                    const mouseX = e.clientX / window.innerWidth;
                    const mouseY = e.clientY / window.innerHeight;

                    const glowBefore = container.querySelector('::before');
                    const glowAfter = container.querySelector('::after');

                    // Subtle parallax movement
                    container.style.setProperty('--mouse-x', mouseX);
                    container.style.setProperty('--mouse-y', mouseY);
                });
            }
        });
    </script>
</body>

</html>
